minimumLimaVersion: 2.0.0

base:
- template:_images/ubuntu-24.04

cpus: 4
memory: "4GiB"
disk: "100GiB"

containerd:
  system: false
  user: false

provision:
# Install Docker Engine
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    command -v docker >/dev/null 2>&1 && exit 0
    export DEBIAN_FRONTEND=noninteractive
    curl -fsSL https://get.docker.com | sh

# Add user to docker group
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    usermod -aG docker "{{.User}}"

# Install dev tools, Go, asdf, and Claude Code
- mode: user
  script: |
    #!/bin/bash
    set -eux -o pipefail

    export DEBIAN_FRONTEND=noninteractive

    # --- Core dev tools ---
    sudo apt-get update
    sudo apt-get install -y \
      build-essential \
      curl \
      git \
      jq \
      ripgrep \
      unzip \
      wget

    # --- Go ---
    if ! command -v go >/dev/null 2>&1; then
      GO_VERSION="1.24.1"
      curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-arm64.tar.gz" | sudo tar -C /usr/local -xz
    fi
    export PATH="/usr/local/go/bin:$HOME/go/bin:$PATH"

    # --- asdf version manager ---
    go install github.com/asdf-vm/asdf/cmd/asdf@v0.18.0
    export ASDF_DATA_DIR="$HOME/.asdf"
    export PATH="$HOME/go/bin:$ASDF_DATA_DIR/shims:$PATH"

    # Add Go and asdf to shell profile
    if ! grep -q 'ASDF_DATA_DIR' "$HOME/.bashrc"; then
      echo 'export PATH="/usr/local/go/bin:$HOME/go/bin:$PATH"' >> "$HOME/.bashrc"
      echo 'export ASDF_DATA_DIR="$HOME/.asdf"' >> "$HOME/.bashrc"
      echo 'export PATH="$HOME/.local/bin:$ASDF_DATA_DIR/shims:$PATH"' >> "$HOME/.bashrc"
    fi

    # --- gopls (Go language server) ---
    go install golang.org/x/tools/gopls@latest

    # --- Claude Code (native install) ---
    curl -fsSL https://claude.ai/install.sh | bash

probes:
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v docker >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "docker is not installed yet"
      exit 1
    fi
    if ! timeout 30s bash -c "until pgrep dockerd; do sleep 3; done"; then
      echo >&2 "dockerd is not running"
      exit 1
    fi
  hint: See "/var/log/cloud-init-output.log" in the guest

hostResolver:
  enabled: false

message: |
  Claude Code sandbox VM is ready.
  Run `limactl shell cco-sandbox` to enter the VM.
