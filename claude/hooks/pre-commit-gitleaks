#!/bin/bash
set -euo pipefail

INPUT=$(cat)
COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command')

# Only intercept git commit commands
if ! echo "$COMMAND" | grep -qE '^git\s+commit\b'; then
  exit 0
fi

# Run gitleaks on staged changes
if ! OUTPUT=$(gitleaks protect --staged 2>&1); then
  jq -n '{
    hookSpecificOutput: {
      hookEventName: "PreToolUse",
      permissionDecision: "deny",
      permissionDecisionReason: ("gitleaks found secrets in staged changes. Fix the leaked secrets before committing.\n\n" + $output)
    }
  }' --arg output "$OUTPUT"
else
  exit 0
fi
