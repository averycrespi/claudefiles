#!/usr/bin/env bash

# Attaches to the tmux session for the current repository.
#
# If the tmux session for the repository doesn't exist, it will be created.
#
# Usage:
#   worktree-attach

set -euo pipefail

# Requirement: must be in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
	echo "Error: Not in a git repository" >&2
	exit 1
fi

# Get the repository root and name
repo_root=$(git rev-parse --show-toplevel)
repo_name=$(basename "$repo_root")

# Check if we're in the main repository or a worktree
git_common_dir=$(git rev-parse --git-common-dir 2>/dev/null)

if [[ "$git_common_dir" == ".git" ]]; then
	# We're in the main repository
	session_name="${repo_name}-worktree"
else
	# We're in a worktree - extract the worktree name
	worktree_path=$(git rev-parse --show-toplevel)
	worktree_name=$(basename "$worktree_path")
	session_name="${repo_name}-worktree"
fi

# Create tmux session if it doesn't exist
worktree-init

# Attach to the session
echo "Attaching to tmux session: $session_name"
if [[ -n "${TMUX:-}" ]]; then
	# Already inside tmux: switch to the target session
	tmux switch-client -t "$session_name"
else
	# Not inside tmux: attach to the session and select
	tmux attach-session -t "$session_name"
fi
