#!/usr/bin/env bash

set -euo pipefail

# Confluence View Script
# Reads a specific Confluence page using the REST API
# Requires: CONFLUENCE_DOMAIN, CONFLUENCE_EMAIL, CONFLUENCE_API_TOKEN

# Default values
METADATA_ONLY=false
PAGE_INPUT=""

# Parse arguments
show_help() {
    cat << EOF
Usage: confluence-view [OPTIONS] <page-id-or-url>

Read a specific Confluence page by ID or URL.

Arguments:
    <page-id-or-url>    Numeric page ID or Confluence URL
                        Supports: ?pageId=123 or /pages/123/Title formats

Options:
    --metadata          Return metadata only (no content) for lightweight queries
    -h, --help          Show this help message

Environment Variables (required):
    CONFLUENCE_DOMAIN      Confluence domain (e.g., mycompany.atlassian.net)
    CONFLUENCE_EMAIL       Email address for authentication
    CONFLUENCE_API_TOKEN   API token from Atlassian account settings

Output:
    JSON format with page data

Examples:
    confluence-view 123456789
    confluence-view "https://mycompany.atlassian.net/wiki/viewpage.action?pageId=123456789"
    confluence-view "https://mycompany.atlassian.net/spaces/ABC/pages/123456789/Page+Title"
    confluence-view 123456789 --metadata
    confluence-view 123456789 | jq '.title'
    confluence-view 123456789 | jq '.content' | pandoc -f html -t markdown
EOF
    exit 0
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            ;;
        --metadata)
            METADATA_ONLY=true
            shift
            ;;
        -*)
            echo "Error: Unknown option: $1" >&2
            echo "Run 'confluence-view --help' for usage information." >&2
            exit 1
            ;;
        *)
            PAGE_INPUT="$1"
            shift
            ;;
    esac
done

# Validate page input is provided
if [[ -z "$PAGE_INPUT" ]]; then
    echo "Error: Page ID or URL is required" >&2
    echo "Run 'confluence-view --help' for usage information." >&2
    exit 1
fi

# Validate environment variables
if [[ -z "${CONFLUENCE_DOMAIN:-}" ]]; then
    echo "Error: CONFLUENCE_DOMAIN environment variable is not set" >&2
    exit 1
fi

if [[ -z "${CONFLUENCE_EMAIL:-}" ]]; then
    echo "Error: CONFLUENCE_EMAIL environment variable is not set" >&2
    exit 1
fi

if [[ -z "${CONFLUENCE_API_TOKEN:-}" ]]; then
    echo "Error: CONFLUENCE_API_TOKEN environment variable is not set" >&2
    exit 1
fi

# Extract page ID from input (handles both numeric IDs and URLs)
extract_page_id() {
    local input="$1"

    # If input is purely numeric, return as-is
    if [[ "$input" =~ ^[0-9]+$ ]]; then
        echo "$input"
        return 0
    fi

    # Try to extract pageId parameter from URL (e.g., ?pageId=123456789)
    if [[ "$input" =~ pageId=([0-9]+) ]]; then
        echo "${BASH_REMATCH[1]}"
        return 0
    fi

    # Try to extract page ID from path-based URL (e.g., /pages/123456789/Page+Title)
    if [[ "$input" =~ /pages/([0-9]+) ]]; then
        echo "${BASH_REMATCH[1]}"
        return 0
    fi

    # If we get here, input format is invalid
    echo "Error: Invalid page ID or URL format" >&2
    echo "Expected: numeric ID, URL with pageId parameter, or /pages/{id}/ path" >&2
    exit 1
}

PAGE_ID=$(extract_page_id "$PAGE_INPUT")

# Infer API path based on domain
infer_api_path() {
    local domain="$1"
    if [[ "$domain" == *".atlassian.net" ]]; then
        echo "/wiki/rest/api"
    else
        echo "/rest/api"
    fi
}

API_PATH=$(infer_api_path "$CONFLUENCE_DOMAIN")

# Construct base URL
BASE_URL="https://${CONFLUENCE_DOMAIN}${API_PATH}"

# Create Basic Auth header
AUTH_STRING="${CONFLUENCE_EMAIL}:${CONFLUENCE_API_TOKEN}"
AUTH_HEADER="Authorization: Basic $(printf '%s' "$AUTH_STRING" | base64)"

# Determine expand parameters based on mode
if [[ "$METADATA_ONLY" == "true" ]]; then
    EXPAND="space"
else
    EXPAND="body.storage,space,version"
fi

# Make API request
HTTP_STATUS=$(curl -s -w "%{http_code}" -o /tmp/confluence-view-response.json \
    -H "$AUTH_HEADER" \
    -H "Content-Type: application/json" \
    "${BASE_URL}/content/${PAGE_ID}?expand=${EXPAND}")

# Check HTTP status
if [[ "$HTTP_STATUS" != "200" ]]; then
    echo "Error: API request failed with status $HTTP_STATUS" >&2

    # Try to show error message from response
    if [[ -f /tmp/confluence-view-response.json ]]; then
        ERROR_MSG=$(jq -r '.message // .errorMessages[0] // "Unknown error"' /tmp/confluence-view-response.json 2>/dev/null || echo "Unknown error")
        echo "Error message: $ERROR_MSG" >&2
    fi

    rm -f /tmp/confluence-view-response.json
    exit 1
fi

# Parse and format response
if [[ "$METADATA_ONLY" == "true" ]]; then
    # Metadata-only mode: exclude content
    jq '{
        id: .id,
        title: .title,
        type: .type,
        status: .status,
        space: {
            key: .space.key,
            name: .space.name
        },
        url: ("https://'"$CONFLUENCE_DOMAIN"'" + (._links.webui // ""))
    }' /tmp/confluence-view-response.json
else
    # Full view mode: include content and version
    jq '{
        id: .id,
        title: .title,
        type: .type,
        status: .status,
        space: {
            key: .space.key,
            name: .space.name
        },
        content: .body.storage.value,
        version: .version.number,
        url: ("https://'"$CONFLUENCE_DOMAIN"'" + (._links.webui // ""))
    }' /tmp/confluence-view-response.json
fi

# Clean up temp file
rm -f /tmp/confluence-view-response.json
